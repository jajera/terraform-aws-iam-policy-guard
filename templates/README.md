# Configuration Templates

This directory contains **template configuration files** that serve as the **source of truth** for IAM Policy Monitor rules and suppressions.

## üìÅ Directory Purpose

### **Production Configuration Templates**

- Production-ready IAM monitoring configurations
- Directly uploaded to S3 by Terraform
- Single source of truth for all environments

## üìã Files

### **`rules.yaml`**

IAM policy violation detection rules:

- **AdminPolicyAttachment** - Detects dangerous policy attachments
- **DangerousInlinePolicy** - Catches overly broad inline policies
- **PrivilegedPolicyAttachment** - Monitors privileged permissions
- **RootUserActivity** - Critical alerts for root user actions
- **CrossAccountAssumeRole** - Cross-account access monitoring
- And more comprehensive rules...

### **`suppress.yaml`**

The `suppress.yaml` file is used to define suppression rules that prevent the detector from firing on known, expected, or low-risk events. This is critical for reducing alert fatigue and ensuring that you only get notified for high-fidelity signals that require investigation.

### Rule Structure and Evaluation

Rules are defined in the `suppressions` list and are evaluated in order from top to bottom. **The first rule that matches an incoming event will suppress it**, and no further suppression rules will be evaluated.

Each rule has a `name`, a `description`, and a set of `conditions` that must be met for the suppression to apply.

### Best-Practice Configuration

The default `suppress.yaml` is organized into logical categories, evaluated in order of importance:

1. **`IAMPolicyMonitorSelfSuppression`**: Prevents the module from creating alerts for its own remediation activities. This is the most important rule for avoiding noisy feedback loops.
2. **`AWSServiceRoles`**: Suppresses events generated by common AWS services that manage their own IAM roles (e.g., EC2, Lambda, ECS). This is a highly effective way to reduce noise from routine AWS operations.
3. **`LowRiskAutomationTools`**: Recognizes common Infrastructure-as-Code (IaC) tools like Terraform, CloudFormation, Ansible, and Pulumi. It suppresses low-risk events like user or role creation/deletion but **intentionally does not suppress policy changes**, ensuring you are still alerted to potentially dangerous IaC deployments.
4. **`ThirdPartySecurityScanners` (Disabled by Default)**: A placeholder rule to make it easy to suppress noise from security scanning tools like Qualys or AWS Inspector. You can enable this and add the appropriate principal ARNs if you use these tools in your environment.

### Global Settings

After the individual rules are processed, a set of `global_settings` are applied to all events:

- **`suppress_read_only_operations`**: If `true`, globally suppresses all IAM `Get*` and `List*` events. This is highly recommended for production environments.
- **`suppress_service_linked_roles`**: If `true`, suppresses any event related to AWS Service-Linked Roles.
- **`minimum_severity_threshold`**: A global filter to suppress any violation with a severity below the specified threshold (e.g., `LOW`, `MEDIUM`).
- **`rate_limiting` & `notification_cooldown`**: These settings help prevent alert storms by limiting the number of notifications sent within a given time window.

### **`notification-config.yaml`**

Slack notification formatting and color mappings:

- **Severity Colors** - Color mapping for different violation severities
- **Event Status Mapping** - Maps IAM events to status types
- **Status Colors** - Specific colors for event types (overrides severity)
- **Slack Configuration** - Message fields, title, and formatting options
- **Notification Settings** - Rate limiting and severity thresholds
- **Emoji Mapping** - Custom emojis for different violation types

## üîÑ How Templates Are Used

### **Terraform Integration**

```hcl
# In main.tf - directly uploads templates to S3
resource "aws_s3_object" "rules" {
  bucket = aws_s3_bucket.rules_and_logs.bucket
  key    = "rules.yaml"
  source = "${path.module}/templates/rules.yaml"
  etag   = filemd5("${path.module}/templates/rules.yaml")
}

resource "aws_s3_object" "suppress" {
  bucket = aws_s3_bucket.rules_and_logs.bucket
  key    = "suppress.yaml"
  source = "${path.module}/templates/suppress.yaml"
  etag   = filemd5("${path.module}/templates/suppress.yaml")
}
```

### **Deployment Flow**

1. **Edit** templates in this directory
2. **Deploy** with `terraform apply`
3. **Lambda functions** automatically load from S3

### **Lambda Runtime**

```python
# Lambda functions load directly from S3
rules_config = self._load_config_from_s3("rules.yaml")
suppress_config = self._load_config_from_s3("suppress.yaml")
```

## üéØ Best Practices

### **Updating Templates**

1. **Edit** `rules.yaml` or `suppress.yaml` in this directory
2. **Test** changes locally with `cd lambdas && python detector.py`
3. **Deploy** with `terraform apply`
4. **Monitor** CloudWatch logs for any issues

### **Version Control**

- All changes are tracked in git
- Use descriptive commit messages
- Review changes before deployment
- Consider staging environment for major changes

## üìö Rule Categories

### **Security Rules**

- Administrative policy monitoring
- Privilege escalation detection
- Cross-account access control
- Root user activity alerts

### **Operational Rules**

- Policy creation/deletion tracking
- Inline policy monitoring
- Service role management
- Unusual activity detection

### **Suppression Categories**

- CI/CD automation allowlists
- Trusted network ranges
- Maintenance windows
- Service account exceptions

## ‚ö° Quick Start

Deploy with default templates:

```bash
terraform init
terraform apply
```

Customize templates:

```bash
# Edit the templates directly
vim templates/rules.yaml
vim templates/suppress.yaml

# Deploy changes
terraform apply
```

## üß™ Testing Changes

Before deploying template changes:

```bash
# Test locally with mock data
cd lambdas
python detector.py
python remediator.py

# Run comprehensive tests
./test-local.sh
```

## Architecture Notes

- **Single source of truth** - Templates are the only configuration source
- **No overrides** - Simplifies deployment and reduces complexity
- **Direct S3 upload** - Templates go straight to S3 for Lambda consumption
- **Immediate effect** - Changes take effect on next Lambda invocation
